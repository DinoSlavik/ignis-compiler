# 7. Керування динамічною пам'яттю: "Вахтер та Ключі"
Керування пам'яттю в Ignis побудовано на унікальній гібридній моделі. Вона поєднує явний контроль над життєвим циклом об'єктів, як у C++, з гарантіями безпеки під час виконання, натхненними Rust. Мета — усунути такі небезпечні помилки, як висячі вказівники, залишаючи програмісту контроль над пам'яттю.

## Філософія: Вахтер та Ключі
В основі системи лежить проста аналогія:

- **"Вахтер" (Рантайм)**: Єдина сутність, яка володіє всією динамічно виділеною пам'яттю ("будинком"). Вона веде детальний журнал всіх об'єктів ("квартир") та посилань на них ("ключів").

- **Змінні ("Ключі")**: Змінні, що вказують на об'єкти в пам'яті, є "ключами". Вони не володіють даними, а лише надають до них доступ.

## Основні принципи
### 1. Створення та знищення об'єктів
Програміст повністю контролює, коли створювати та знищувати об'єкти в динамічній пам'яті (купі).

- **Створення (`new`):** Оператор `new` (синтаксис буде визначено пізніше) дає команду "Вахтеру" виділити пам'ять під новий об'єкт. "Вахтер" створює об'єкт і видає програмісту перший "ключ".

- **Знищення (`free`):** Оператор `free` дає команду "Вахтеру" знищити об'єкт та анулювати всі ключі, пов'язані з ним.

```Ignis

// Синтаксис є гіпотетичним
// 1. "Вахтер" створює об'єкт Point і видає нам ключ `p1`.
mut Point p1 = new Point;

// ... робота з об'єктом ...

// 2. Даємо команду "Вахтеру" знищити об'єкт.
free(p1);
```

Важливо: Якщо free не було викликано, пам'ять буде зайнята до кінця роботи програми. Це може призвести до витоків пам'яті.

### 2. Змінні як "Ключі"
Присвоєння змінних, що вказують на об'єкти в купі, не копіює об'єкт, а створює новий "ключ" (посилання) до того ж самого об'єкта.

```Ignis

mut Point p1 = new Point;

// "Вахтер" створює новий ключ `p2`, який веде до того ж об'єкта.
// Копіювання не відбувається.
Point p2 = p1;
```

### 3. Типи ключів та дозволи
Існує два типи "ключів", що визначають права доступу до об'єкта:

- **Ключ Власника (Owner Key):** Перша змінна, якій присвоюється новостворений об'єкт. Цей ключ має повні права на читання та запис.

- **Гостьовий Ключ (Guest Key):** Будь-який ключ, створений через просте присвоєння (p2 = p1). За замовчуванням, він має право лише на читання.

Для створення нового ключа з повними правами на запис буде введено спеціальну властивість (наприклад, permall).

## Гарантії безпеки (Перевірки під час виконання)
"Вахтер" забезпечує безпеку, перевіряючи всі операції з ключами під час виконання програми.

Запобігання "висячим вказівникам"
Це ключова особливість системи. Коли програміст викликає free(p1):

1) "Вахтер" знаходить об'єкт, на який вказує p1.

2) Він переглядає свій журнал і знаходить всі інші ключі (p2, p3...), що вказують на цей об'єкт.

3) Він анулює всі ці ключі.

4) Лише після цього він звільняє пам'ять.

Будь-яка подальша спроба використати анульований ключ (p2) призведе до контрольованої помилки часу виконання (напр., "Спроба доступу за недійсним посиланням"), а не до невизначеної поведінки чи падіння програми.
